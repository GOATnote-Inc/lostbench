name: Adversarial Regression

on:
  schedule:
    - cron: '0 6 * * 1'  # Weekly Monday 6am UTC
  workflow_dispatch:
    inputs:
      model:
        description: 'Model to test'
        required: true
        default: 'gpt-5.2'
      provider:
        description: 'Provider'
        required: true
        default: 'openai'
      full_suite:
        description: 'Run full suite (not just regression subset)'
        type: boolean
        default: false
      n_trials:
        description: 'Number of trials'
        required: false
        default: '1'

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  regression:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4 hour max for full suite

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Determine configuration
        id: config
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "model=gpt-5.2" >> $GITHUB_OUTPUT
            echo "provider=openai" >> $GITHUB_OUTPUT
            echo "template=configs/campaign_templates/regression_fast.yaml" >> $GITHUB_OUTPUT
            echo "n_trials=1" >> $GITHUB_OUTPUT
          else
            MODEL="${{ github.event.inputs.model }}"
            PROVIDER="${{ github.event.inputs.provider }}"
            N_TRIALS="${{ github.event.inputs.n_trials }}"
            if [ "${{ github.event.inputs.full_suite }}" = "true" ]; then
              TEMPLATE="configs/campaign_templates/regression_full.yaml"
              N_TRIALS="${N_TRIALS:-3}"
            else
              TEMPLATE="configs/campaign_templates/regression_fast.yaml"
              N_TRIALS="${N_TRIALS:-1}"
            fi
            echo "model=${MODEL}" >> $GITHUB_OUTPUT
            echo "provider=${PROVIDER}" >> $GITHUB_OUTPUT
            echo "template=${TEMPLATE}" >> $GITHUB_OUTPUT
            echo "n_trials=${N_TRIALS}" >> $GITHUB_OUTPUT
          fi

      - name: Run adversarial regression
        run: |
          python scripts/run_campaign.py \
            --template ${{ steps.config.outputs.template }} \
            --model ${{ steps.config.outputs.model }} \
            --provider ${{ steps.config.outputs.provider }} \
            --output-dir results/regression-$(date +%Y%m%d)/

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-results-${{ steps.config.outputs.model }}
          path: results/regression-*/
          retention-days: 90
